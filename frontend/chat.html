<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVAI - Chat IA</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <img src="logo.png" alt="NOVAI Logo" class="logo-image">
                </div>
            </div>

            <nav class="nav-menu">
                <a href="/" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">üë§</div>
                        <div class="nav-label">Mon Profil</div>
                    </div>
                </a>
                <a href="/personality.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">‚ú®</div>
                        <div class="nav-label">Test Personnalit√©</div>
                    </div>
                </a>
                <a href="/chat.html" class="nav-item-link">
                    <div class="nav-item active">
                        <div class="nav-icon">üí¨</div>
                        <div class="nav-label">Chat IA</div>
                    </div>
                </a>
                <a href="/quiz.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">üéØ</div>
                        <div class="nav-label">Quiz & Tests</div>
                    </div>
                </a>
                <a href="/events.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">üìÖ</div>
                        <div class="nav-label">√âv√©nements</div>
                    </div>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <a href="/logout.html" class="header-icon-btn logout-btn" title="D√©connexion">
                        üö™
                    </a>
                </div>

                <div class="header-center">
                    <div class="tagline-banner">
                        <p>‚ú® NovAI : Le site qui cr√©e des √©toiles ‚ú®</p>
                    </div>
                </div>

                <div class="header-right">
                    <div class="header-icon-btn" id="settingsBtn">
                        ‚öôÔ∏è
                        <div class="settings-dropdown" id="settingsDropdown">
                            <div class="dropdown-item">Style du site</div>
                            <div class="dropdown-item">Support</div>
                            <div class="dropdown-item">Abonnement</div>
                            <div class="dropdown-item">Nos partenaires</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1>Chat IA</h1>
                    <p>Posez vos questions √† l'Assistant NOVAI</p>
                </div>

                <!-- Chat Section -->
                <div class="chat-section">
                    <div class="chat-header">
                        <div class="chat-avatar">üí¨</div>
                        <div class="chat-info">
                            <h3>Assistant NOVAI</h3>
                            <p>‚óè En ligne - √Ä votre service</p>
                        </div>
                    </div>

                    <div class="chat-messages">
                        <div class="message bot">
                            <div class="message-bubble">
                                Bonjour ! Je suis l'Assistant NOVAI. Je suis ici pour r√©pondre √† toutes vos questions sur les m√©tiers du num√©rique, les formations et les opportunit√©s de carri√®re. Comment puis-je vous aider ?
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <input type="text" id="chatInput" name="chatInput" class="chat-input" placeholder="Posez votre question...">
                        <button type="button" id="sendBtn" class="send-btn">‚úì</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ SCRIPT START - Page chat.html loaded');
        
        // Settings dropdown toggle
        document.getElementById('settingsBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('settingsDropdown').classList.toggle('active');
        });

        // Close dropdown when clicking elsewhere (except chat area)
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.chat-section')) {
                document.getElementById('settingsDropdown').classList.remove('active');
            }
        });

        // Chat functionality - Execute immediately (script is at end of body)
        console.log('üîç Initializing chat...');
        
        const input = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesEl = document.querySelector('.chat-messages');

        console.log('üì¶ Elements:', { 
            input: input ? 'FOUND' : 'NOT FOUND', 
            sendBtn: sendBtn ? 'FOUND' : 'NOT FOUND', 
            messagesEl: messagesEl ? 'FOUND' : 'NOT FOUND'
        });

        if (!input || !sendBtn || !messagesEl) {
            console.error('‚ùå ERREUR: Elements manquants!', { input, sendBtn, messagesEl });
            alert('ERREUR: Elements du chat non trouv√©s. Rechargez la page.');
        } else {
            console.log('‚úÖ All elements found, attaching listeners...');

            function appendMessage(text, who) {
                console.log('üí¨ Appending message:', who, '-', text.substring(0, 50) + '...');
                const wrapper = document.createElement('div');
                wrapper.className = `message ${who}`;
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                wrapper.appendChild(bubble);
                messagesEl.appendChild(wrapper);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            async function sendMessage() {
                console.log('üì§ === sendMessage CALLED ===');
                const text = input.value ? input.value.trim() : '';
                console.log('üìù Input text:', text ? `"${text}"` : '(empty)');
                
                if (!text) {
                    console.log('‚ö†Ô∏è No text, aborting');
                    return;
                }

                appendMessage(text, 'user');
                input.value = '';
                sendBtn.disabled = true;
                sendBtn.textContent = '‚Ä¶';

                try {
                    console.log('üåê Fetching /api/chat...');
                    const resp = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text })
                    });

                    console.log('üì° Response status:', resp.status, resp.statusText);

                    if (!resp.ok) {
                        const err = await resp.json().catch(()=>({ error: 'Erreur serveur' }));
                        console.error('‚ùå Error response:', err);
                        appendMessage('Erreur: ' + (err.error || resp.statusText), 'bot');
                    } else {
                        const data = await resp.json();
                        console.log('‚úÖ Success response:', data);
                        appendMessage(data.reply || 'D√©sol√©, pas de r√©ponse.', 'bot');
                    }
                } catch (e) {
                    console.error('‚ùå === FETCH ERROR ===', e);
                    appendMessage('Erreur de connexion: ' + e.message, 'bot');
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = '‚úì';
                    console.log('üîÑ Button restored');
                }
            }

            // Button click handler
            sendBtn.addEventListener('click', function(e) {
                console.log('üñ±Ô∏è === BUTTON CLICKED ===');
                e.stopPropagation();
                e.preventDefault();
                sendMessage();
            });

            // Enter key handler
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    console.log('‚å®Ô∏è === ENTER PRESSED ===');
                    e.preventDefault();
                    sendMessage();
                }
            });

            console.log('‚úÖ Chat listeners attached successfully!');
            console.log('üëâ Try typing a message and clicking send or pressing Enter');
        }
    </script>
</body>
</html>

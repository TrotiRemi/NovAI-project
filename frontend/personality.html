<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVAI - Test de Personnalit√©</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <img src="logo.png" alt="NOVAI Logo" class="logo-image">
                </div>
            </div>

            <nav class="nav-menu">
                <div class="nav-dropdown">
                    <div class="nav-item-link nav-dropdown-trigger" onclick="toggleNavDropdown(event)">
                        <div class="nav-item">
                            <div class="nav-icon">üë§</div>
                            <div class="nav-label">MOI</div>
                            <div class="nav-dropdown-arrow">‚ñº</div>
                        </div>
                    </div>
                    <div class="nav-dropdown-menu">
                        <a href="/profil.html" class="nav-dropdown-item">
                            <div class="dropdown-icon">üìã</div>
                            <div class="dropdown-label">Mon Profil</div>
                        </a>
                        <a href="/gouts.html" class="nav-dropdown-item">
                            <div class="dropdown-icon">‚ù§Ô∏è</div>
                            <div class="dropdown-label">Mes Go√ªts</div>
                        </a>
                        <a href="/capacites.html" class="nav-dropdown-item">
                            <div class="dropdown-icon">üß†</div>
                            <div class="dropdown-label">Mes Capacit√©s</div>
                        </a>
                    </div>
                </div>
                <a href="/quiz.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">üéØ</div>
                        <div class="nav-label">Quiz & Tests</div>
                    </div>
                </a>
                <a href="/events.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">üìÖ</div>
                        <div class="nav-label">Mes √âv√©nements</div>
                    </div>
                </a>
                <a href="/journey.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">üó∫Ô∏è</div>
                        <div class="nav-label">Mon Parcours</div>
                    </div>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <a href="/" class="header-icon-btn nav-home-btn active" title="Mon Parcours">
                        üó∫Ô∏è
                    </a>
                    <a href="/logout.html" class="header-icon-btn logout-btn" title="D√©connexion">
                        üö™
                    </a>
                </div>

                <div class="header-center">
                    <div class="progress-blocks">
                        <div class="progress-block active">
                            <span class="block-number">1</span>
                            <span class="block-label">Te connaitre</span>
                        </div>
                        <div class="progress-block">
                            <span class="block-number">2</span>
                            <span class="block-label">Te tester</span>
                        </div>
                        <div class="progress-block">
                            <span class="block-number">3</span>
                            <span class="block-label">D√©couverte</span>
                        </div>
                        <div class="progress-block">
                            <span class="block-number">4</span>
                            <span class="block-label">Ev√©nements</span>
                        </div>
                        <div class="progress-block">
                            <span class="block-number">5</span>
                            <span class="block-label">Approf.</span>
                        </div>
                    </div>
                </div>

                <div class="header-right">
                    <div class="header-icon-btn" id="settingsBtn">
                        ‚öôÔ∏è
                        <div class="settings-dropdown" id="settingsDropdown">
                            <div class="dropdown-item">Style du site</div>
                            <div class="dropdown-item">Support</div>
                            <div class="dropdown-item">Abonnement</div>
                            <div class="dropdown-item">Nos partenaires</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1>D√©couvre ta Personnalit√©</h1>
                    <p>R√©ponds aux questions pour mieux comprendre tes traits et tes affinit√©s professionnelles</p>
                </div>

                <div class="personality-chat">
                    <div class="chat-header">
                        <div class="chat-avatar">‚ú®</div>
                        <div class="chat-info">
                            <h3>Assistant D√©couverte</h3>
                            <p>‚óè En ligne - Pr√™te √† te conna√Ætre</p>
                        </div>
                    </div>

                    <div class="chat-messages">
                        <div class="message bot">
                            <div class="message-bubble">
                                Salut ! Je suis l√† pour mieux te conna√Ætre. √Ä travers nos √©changes, je d√©couvrirai tes forces, tes passions et comment tu pourrais les mettre √† profit dans le monde du num√©rique. üåü
                            </div>
                        </div>
                        <div class="message bot">
                            <div class="message-bubble">
                                Par o√π commen√ßons-nous ? Dis-moi, qu'est-ce qui te motive le plus dans la vie ?
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <input type="text" id="personalityInput" name="personalityInput" class="chat-input" placeholder="Partage tes pens√©es...">
                        <button type="button" id="personalitySendBtn" class="send-btn">‚úì</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ SCRIPT START - Page personality.html loaded');
        
        // Settings dropdown toggle
        document.getElementById('settingsBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('settingsDropdown').classList.toggle('active');
        });

        // Close dropdown when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.personality-chat')) {
                document.getElementById('settingsDropdown').classList.remove('active');
            }
        });

        // Personality Chat functionality with conversation history
        console.log('üîç Initializing personality chat...');
        
        const input = document.getElementById('personalityInput');
        const sendBtn = document.getElementById('personalitySendBtn');
        const messagesEl = document.querySelector('.chat-messages');
        
        // Store conversation history for context
        let conversationHistory = [];

        console.log('üì¶ Elements:', { 
            input: input ? 'FOUND' : 'NOT FOUND', 
            sendBtn: sendBtn ? 'FOUND' : 'NOT FOUND', 
            messagesEl: messagesEl ? 'FOUND' : 'NOT FOUND'
        });

        if (!input || !sendBtn || !messagesEl) {
            console.error('‚ùå ERREUR: Elements manquants!', { input, sendBtn, messagesEl });
            alert('ERREUR: Elements du chat non trouv√©s. Rechargez la page.');
        } else {
            console.log('‚úÖ All elements found, attaching listeners...');

            function appendMessage(text, who) {
                console.log('üí¨ Appending message:', who, '-', text.substring(0, 50) + '...');
                const wrapper = document.createElement('div');
                wrapper.className = `message ${who}`;
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                wrapper.appendChild(bubble);
                messagesEl.appendChild(wrapper);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            async function sendMessage() {
                console.log('üì§ === sendMessage CALLED ===');
                const text = input.value ? input.value.trim() : '';
                console.log('üìù Input text:', text ? `"${text}"` : '(empty)');
                
                if (!text) {
                    console.log('‚ö†Ô∏è No text, aborting');
                    return;
                }

                // Add user message to history and display
                conversationHistory.push({ role: 'user', content: text });
                appendMessage(text, 'user');
                input.value = '';
                sendBtn.disabled = true;
                sendBtn.textContent = '‚Ä¶';

                try {
                    console.log('üåê Fetching /api/chat-personality...');
                    console.log('üìö Conversation history length:', conversationHistory.length);
                    
                    const resp = await fetch('/api/chat-personality', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: text,
                            conversationHistory: conversationHistory.slice(0, -1) // Don't include the message we just added
                        })
                    });

                    console.log('üì° Response status:', resp.status, resp.statusText);

                    if (!resp.ok) {
                        const err = await resp.json().catch(()=>({ error: 'Erreur serveur' }));
                        console.error('‚ùå Error response:', err);
                        appendMessage('Erreur: ' + (err.error || resp.statusText), 'bot');
                    } else {
                        const data = await resp.json();
                        console.log('‚úÖ Success response:', data);
                        const reply = data.reply || 'D√©sol√©, pas de r√©ponse.';
                        
                        // Add assistant response to history
                        conversationHistory.push({ role: 'assistant', content: reply });
                        appendMessage(reply, 'bot');
                    }
                } catch (e) {
                    console.error('‚ùå === FETCH ERROR ===', e);
                    appendMessage('Erreur de connexion: ' + e.message, 'bot');
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = '‚úì';
                    console.log('üîÑ Button restored');
                }
            }

            // Button click handler
            sendBtn.addEventListener('click', function(e) {
                console.log('üñ±Ô∏è === BUTTON CLICKED ===');
                e.stopPropagation();
                e.preventDefault();
                sendMessage();
            });

            // Enter key handler
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    console.log('‚å®Ô∏è === ENTER PRESSED ===');
                    e.preventDefault();
                    sendMessage();
                }
            });

            console.log('‚úÖ Personality chat listeners attached successfully!');
            console.log('üëâ Try typing about your interests and clicking send');
        }

        // Navigation dropdown toggle
        function toggleNavDropdown(event) {
            event.preventDefault();
            const dropdown = event.currentTarget.closest('.nav-dropdown');
            const menu = dropdown.querySelector('.nav-dropdown-menu');
            const arrow = dropdown.querySelector('.nav-dropdown-arrow');
            
            menu.classList.toggle('active');
            arrow.textContent = menu.classList.contains('active') ? '‚ñ≤' : '‚ñº';
        }

        // Close nav dropdown when clicking a link
        document.querySelectorAll('.nav-dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const dropdown = this.closest('.nav-dropdown');
                const menu = dropdown.querySelector('.nav-dropdown-menu');
                const arrow = dropdown.querySelector('.nav-dropdown-arrow');
                menu.classList.remove('active');
                arrow.textContent = '‚ñº';
            });
        });
    </script>
</body>
</html>

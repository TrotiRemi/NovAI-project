<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVAI - Test de PersonnalitÃ©</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <img src="logo.png" alt="NOVAI Logo" class="logo-image">
                </div>
            </div>

            <nav class="nav-menu">
                <a href="/" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">ğŸ‘¤</div>
                        <div class="nav-label">Mon Profil</div>
                    </div>
                </a>
                <a href="/personality.html" class="nav-item-link">
                    <div class="nav-item active">
                        <div class="nav-icon">âœ¨</div>
                        <div class="nav-label">Test PersonnalitÃ©</div>
                    </div>
                </a>
                <a href="/chat.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">ğŸ’¬</div>
                        <div class="nav-label">Chat IA</div>
                    </div>
                </a>
                <a href="/quiz.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">ğŸ¯</div>
                        <div class="nav-label">Quiz & Tests</div>
                    </div>
                </a>
                <a href="/events.html" class="nav-item-link">
                    <div class="nav-item">
                        <div class="nav-icon">ğŸ“…</div>
                        <div class="nav-label">Ã‰vÃ©nements</div>
                    </div>
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <a href="/logout.html" class="header-icon-btn logout-btn" title="DÃ©connexion">
                        ğŸšª
                    </a>
                </div>

                <div class="header-center">
                    <div class="tagline-banner">
                        <p>âœ¨ NovAI : Le site qui crÃ©e des Ã©toiles âœ¨</p>
                    </div>
                </div>

                <div class="header-right">
                    <div class="header-icon-btn" id="settingsBtn">
                        âš™ï¸
                        <div class="settings-dropdown" id="settingsDropdown">
                            <div class="dropdown-item">Style du site</div>
                            <div class="dropdown-item">Support</div>
                            <div class="dropdown-item">Abonnement</div>
                            <div class="dropdown-item">Nos partenaires</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="page-header">
                    <h1>DÃ©couvre ta PersonnalitÃ©</h1>
                    <p>RÃ©ponds aux questions pour mieux comprendre tes traits et tes affinitÃ©s professionnelles</p>
                </div>

                <div class="personality-chat">
                    <div class="chat-header">
                        <div class="chat-avatar">âœ¨</div>
                        <div class="chat-info">
                            <h3>Assistant DÃ©couverte</h3>
                            <p>â— En ligne - PrÃªte Ã  te connaÃ®tre</p>
                        </div>
                    </div>

                    <div class="chat-messages">
                        <div class="message bot">
                            <div class="message-bubble">
                                Salut ! Je suis lÃ  pour mieux te connaÃ®tre. Ã€ travers nos Ã©changes, je dÃ©couvrirai tes forces, tes passions et comment tu pourrais les mettre Ã  profit dans le monde du numÃ©rique. ğŸŒŸ
                            </div>
                        </div>
                        <div class="message bot">
                            <div class="message-bubble">
                                Par oÃ¹ commenÃ§ons-nous ? Dis-moi, qu'est-ce qui te motive le plus dans la vie ?
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <input type="text" id="personalityInput" name="personalityInput" class="chat-input" placeholder="Partage tes pensÃ©es...">
                        <button type="button" id="personalitySendBtn" class="send-btn">âœ“</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('ğŸš€ SCRIPT START - Page personality.html loaded');
        
        // Settings dropdown toggle
        document.getElementById('settingsBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('settingsDropdown').classList.toggle('active');
        });

        // Close dropdown when clicking elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.personality-chat')) {
                document.getElementById('settingsDropdown').classList.remove('active');
            }
        });

        // Personality Chat functionality with conversation history
        console.log('ğŸ” Initializing personality chat...');
        
        const input = document.getElementById('personalityInput');
        const sendBtn = document.getElementById('personalitySendBtn');
        const messagesEl = document.querySelector('.chat-messages');
        
        // Store conversation history for context
        let conversationHistory = [];

        console.log('ğŸ“¦ Elements:', { 
            input: input ? 'FOUND' : 'NOT FOUND', 
            sendBtn: sendBtn ? 'FOUND' : 'NOT FOUND', 
            messagesEl: messagesEl ? 'FOUND' : 'NOT FOUND'
        });

        if (!input || !sendBtn || !messagesEl) {
            console.error('âŒ ERREUR: Elements manquants!', { input, sendBtn, messagesEl });
            alert('ERREUR: Elements du chat non trouvÃ©s. Rechargez la page.');
        } else {
            console.log('âœ… All elements found, attaching listeners...');

            function appendMessage(text, who) {
                console.log('ğŸ’¬ Appending message:', who, '-', text.substring(0, 50) + '...');
                const wrapper = document.createElement('div');
                wrapper.className = `message ${who}`;
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                wrapper.appendChild(bubble);
                messagesEl.appendChild(wrapper);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            async function sendMessage() {
                console.log('ğŸ“¤ === sendMessage CALLED ===');
                const text = input.value ? input.value.trim() : '';
                console.log('ğŸ“ Input text:', text ? `"${text}"` : '(empty)');
                
                if (!text) {
                    console.log('âš ï¸ No text, aborting');
                    return;
                }

                // Add user message to history and display
                conversationHistory.push({ role: 'user', content: text });
                appendMessage(text, 'user');
                input.value = '';
                sendBtn.disabled = true;
                sendBtn.textContent = 'â€¦';

                try {
                    console.log('ğŸŒ Fetching /api/chat-personality...');
                    console.log('ğŸ“š Conversation history length:', conversationHistory.length);
                    
                    const resp = await fetch('/api/chat-personality', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: text,
                            conversationHistory: conversationHistory.slice(0, -1) // Don't include the message we just added
                        })
                    });

                    console.log('ğŸ“¡ Response status:', resp.status, resp.statusText);

                    if (!resp.ok) {
                        const err = await resp.json().catch(()=>({ error: 'Erreur serveur' }));
                        console.error('âŒ Error response:', err);
                        appendMessage('Erreur: ' + (err.error || resp.statusText), 'bot');
                    } else {
                        const data = await resp.json();
                        console.log('âœ… Success response:', data);
                        const reply = data.reply || 'DÃ©solÃ©, pas de rÃ©ponse.';
                        
                        // Add assistant response to history
                        conversationHistory.push({ role: 'assistant', content: reply });
                        appendMessage(reply, 'bot');
                    }
                } catch (e) {
                    console.error('âŒ === FETCH ERROR ===', e);
                    appendMessage('Erreur de connexion: ' + e.message, 'bot');
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'âœ“';
                    console.log('ğŸ”„ Button restored');
                }
            }

            // Button click handler
            sendBtn.addEventListener('click', function(e) {
                console.log('ğŸ–±ï¸ === BUTTON CLICKED ===');
                e.stopPropagation();
                e.preventDefault();
                sendMessage();
            });

            // Enter key handler
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    console.log('âŒ¨ï¸ === ENTER PRESSED ===');
                    e.preventDefault();
                    sendMessage();
                }
            });

            console.log('âœ… Personality chat listeners attached successfully!');
            console.log('ğŸ‘‰ Try typing about your interests and clicking send');
        }
    </script>
</body>
</html>
